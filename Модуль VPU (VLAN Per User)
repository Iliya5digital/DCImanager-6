Модуль VPU (VLAN Per User) позволяет поместить каждый сервер в отдельный широковещательный домен. Использование широковещательных доменов помогает:

сократить объём широковещательного трафика;
сократить количество коллизий;
предотвратить сетевые атаки типа IP-спуфинг.
В текущей реализации работа модуля доступна с коммутаторами:

Juniper QFX.
Для работы модуля с другим оборудованием вы можете создать собственный обработчик. Подробнее см. в статье Создание обработчика VPU.

Логика работыLink to Логика работы
Для работы сервера в широковещательном домене модуль:

Создаёт VPU-сеть для сервера. Для создания сети модуль использует пул IP-адресов, заданный в настройках.
Добавляет VPU-сеть в настройки коммутатора или маршрутизатора. Для этого сервис работы с оборудованием:
Создаст на устройстве VLAN, которому принадлежит VPU-сеть.
Создаст IRB-интерфейс для этой VLAN.
Настроит опцию dhcp-relay.
Назначает серверу один из IP-адресов VPU-сети в качестве основного адреса.
Назначает шлюз VPU-сети IRB-интерфейсу коммутатора.
При необходимости назначает серверу дополнительные IP-адреса из пула, заданного в настройках модуля. Для маршрутизации этих адресов используется протокол BGP и сервис bird.
Перед выполнением операции на сервере:
При необходимости создаёт VPU-сеть для BMC сервера. Для создания сети модуль использует пул IP-адресов, заданный в настройках.
Изменяет сетевые настройки BMC — адрес, основной шлюз и сеть.
Перемещает сервер во VLAN, которому принадлежит VPU-сеть.
Во время настройки модуля DCImanager 6 устанавливает и настраивает на локации сервис bird. Сервис используется для передачи сведений о BGP-маршрутах. При настройке bird платформа:

Добавляет в шаблон конфигурационного файла bird данные из настроек модуля.
Отправляет конфигурационный файл на локацию и проверяет его утилитой birdc.
Если ошибок в конфигурационном файле не найдено, заменяет текущую конфигурацию и перезапускает bird. Если найдены ошибки, отменяет задачу на настройку bird.
При успешной настройке сервис bird запустит синхронизацию маршрутов на сетевом оборудовании. После синхронизации маршрутов в платформе появится возможность создавать VPU-сети.

Для повышения стабильности работы bird платформа создаёт резервный файл со статическими маршрутами. При перезапуске bird платформа восстанавливает сетевые маршруты из этого файла.

Подготовка к установке модуляLink to Подготовка к установке модуля
Перед установкой:

Создайте пулы IPv4-адресов и физические сети:
Для серверов в широковещательных доменах.
Для BMC серверов.
Для дополнительных IP-адресов.
Настройте протокол BGP на коммутаторе или маршрутизаторе.
Пример настройки BGP на маршрутизаторе Juniper QFX
Задайте номер автономной системы BGP:
Откройте режим конфигурации.
Зайдите в настройки routing-options:

{master:0}[edit]
root# edit routing-options
Установите номер автономной системы. Например, 121:

{master:0}[edit routing-options]
root# set autonomous-system 121
Проверьте конфигурацию. Номер автономной системы находится в параметре autonomous-system.

{master:0}[edit routing-options]
root# show
Пример ответа

static {
    route 0.0.0.0/0 next-hop 10.99.0.1;
}
autonomous-system 121;
Сохраните изменения:

{master:0}[edit routing-options]
root# commit
Настройте подключения к "соседям" автономной системы:
Зайдите в настройки редактирования протокола:

{master:0}[edit]
root# edit protocols bgp
Укажите настройки для группы устройств и IP-адрес участника:

{master:0}[edit protocols bgp]
root# set group internal type internal neighbor 10.99.0.11
 Пояснения к команде
Задайте локальный адрес маршрутизатора:

{master:0}[edit protocols bgp]
root# set group internal local-address 10.0.0.1
 Пояснения к команде
Проверьте конфигурацию:

{master:0}[edit protocols bgp]
root# show
Пример ответа

traceoptions {
    file bgp.log size 1m files 50;
}
advertise-inactive;
log-updown;
damping;
local-as 121;
group internal {
    type internal;
    local-address 10.0.0.1;
    neighbor 10.99.0.11;
}
Сохраните изменения:

{master:0}[edit protocols bgp]
root# commit
Проверьте конфигурацию:

show bgp summary
При успешной настройке статус протокола в колонке State должен быть Active.

Threading mode: BGP I/O
Groups: 1 Peers: 1 Down peers: 1
Table          Tot Paths  Act Paths Suppressed    History Damp State    Pending
inet.0
                       0          0          0          0          0          0
Peer                     AS      InPkt     OutPkt    OutQ   Flaps Last Up/Dwn State|#Active/Received/Accepted/Damped...
10.99.0.150             121          0          0       0       0 4w2d 1:02:35 Active
Установка модуляLink to Установка модуля
Чтобы установить модуль, перейдите в  → Модули → VPU (Vlan per user) → Установить.

Настройка модуляLink to Настройка модуля
Для настройки перейдите в  → Модули → VPU (Vlan per user) → Перейти к настройкам → Настроить:

Выберите Обработчик для VPU.
Укажите Настройки сетей:
Выберите Пул для VPU. Используется для автоматической работы модуля VPU из биллинговой системы.
Выберите Пул для BMC. Используется для автоматической работы модуля VPU из биллинговой системы.
Выберите Пул для дополнительных IP-адресов. Физические сети из этого пула автоматически подставятся в поле Сети провайдера.
Пул используется для автоматической работы модуля VPU из биллинговой системы.
Укажите Сети провайдера — IPv4-сети для дополнительных IP-адресов сервера. Дополнительные адреса серверов, которые не принадлежат ни одной из перечисленных сетей, не будут передаваться на маршрутизатор при помощи BGP.
Укажите Настройки BGP-сессии для IPv4:
Номер Локальной автономной системы BGP.
BGP community для IPv4 в формате: ASN[:VALUE][:VALUE]. Для использования доступны community от 1:0:0 до 65534:65535:65535.
IPv4 соседа.
Автономная система соседа.

Произвольное Примечание Bird.
Нажмите Далее.
Укажите Настройки маршрутизации — данные для подключения к комутатору:
IP-адрес. Значение по умолчанию подставляется автоматически из поля IPv4 соседа.
Порт.

Пользователь SSH.
Пароль SSH.
Нажмите Далее.
Если вы используете собственный обработчик, укажите его настройки:
Нажмите Добавить настройку.
Укажите Ключ и Значение настройки.
Нажмите Настроить VPU на локации.

Пример настройки


Для управления настройками модуля перейдите в  → Модули → VPU (Vlan per user) → Перейти к настройкам.

Чтобы изменить настройки, нажмите на название соответствующей локации.

Чтобы удалить настройки, нажмите .

Чтобы настроить модуль для другой локации, нажмите Настроить VPU на локации.


Интерфейс раздела настроек

Настройка сетей VPULink to Настройка сетей VPU
Управлять VPU-сетями вы можете в разделе Сеть → Виртуальные сети (VLAN) → выберите VLAN → Сети VPU.

Чтобы создать VPU-сеть: 

Нажмите добавить сеть VPU.
Выберите назначение сети:

сеть VPU для серверов:
Укажите Префикс сети:
для IPv4 — от /25 до /31;
для IPv6 — от /64 до /127.
Выберите Пул.
Чтобы VLAN использовала VPU-сеть в качестве локального адреса для широковещательного трафика, включите опцию Сделать основной IPv4-сетью.
Укажите произвольное Примечание.
Нажмите Применить.
сеть VPU для BMC:
Укажите Префикс сети от /25 до /30.
Выберите Пул.
Укажите произвольное Примечание.
Нажмите Применить.
Через меню вы можете выполнять операции с VPU-сетями:

Примечание — указать произвольное примечание;
Сделать основной сетью;
Удалить сеть VPU.

Интерфейс раздела "Сети VPU"

Выделение IP-адресов для серверов и BMCLink to Выделение IP-адресов для серверов и BMC
Для выделения IP-адреса для сервера из созданной VPU-сети:

Перейдите в Серверы → выберите нужный сервер → Настройки → Сетевые.
Нажмите выделить.
Выберите Из VPU-сети.
Выберите нужную VLAN. Сервер будет помещён в этот VLAN при выполнении операций.
Укажите VPU-сеть.
Укажите Хост.
Нажмите Выделить IP-адрес. По умолчанию первый выделенный IP-адрес станет основным IPv4-адресом для сервера.

Обратите внимание!

Назначить адрес не из VPU-сети основным нельзя, если на сервере есть адрес из VPU-сети.

Выделение IP-адреса для BMC из созданной VPU-сети доступно на форме редактирования настроек BMC:

Перейдите в Серверы → выберите нужный сервер → BMC → Меню → Настройки.
Нажмите изменить IP-адрес.
Выберите выделение IP-адреса Из VPU-сети.
Выберите VPU-сеть из нужной VLAN. Это VLAN, в которой находится VPU-сеть сервера.
Нажмите Сохранить.

Обратите внимание!

Выделение IP-адресов для серверов и BMC из BILLmanager происходит автоматически. Рекомендуем настроить VLAN при освобождении, чтобы при закрытии услуги в биллинговой системе или освобождении сервера вручную, сервер возвращался во VLAN по умолчанию. Подробнее см. Добавление освобождаемых серверов во VLAN.

Удаление модуляLink to Удаление модуля
Для удаления модуля:

Шаг 1. Освободите все занятые IP-адреса, которые принадлежат сетям VPU
Чтобы освободить IP-адрес, выделенный для сервера:

Перейдите в Сеть → Виртуальные сети (VLAN) → выберите VLAN → Сети VPU → выберите сеть → меню  → Занятые IP-адреса .
Нажмите  для удаления IP-адреса.
Чтобы освободить IP-адрес, выделенный для BMC:

Перейдите в Сеть → Виртуальные сети (VLAN) → выберите VLAN → Сети VPU → выберите сеть → меню  → Занятые IP-адреса.
Нажмите на ссылку BMC → Меню → Настройки → изменить IP-адрес.
Выберите Ввести существующий и укажите новый IP-адрес.
Нажмите Сохранить.
Шаг 2. Удалите все VPU-сети из всех VLAN.
Для этого перейдите в Сеть → Виртуальные сети (VLAN) → выберите VLAN → Сети VPU → выберите сеть → меню  → Удалить сеть VPU. Повторите для всех VLAN, у которых настроены VPU-сети.

Шаг 3. Удалите настройки VPU на всех локациях.
Для этого:

Перейдите в  → Модули → VPU (Vlan per user) → Перейти к настройкам.
Нажмите  на нужной локации → Удалить настройки VPU. Повторите для других локаций, у которых настроен VPU.
Шаг 4. Удалите модуль VPU
Для удаления модуля перейдите в  → Модули → VPU (Vlan per user) → Удалить → Удалить модуль.
