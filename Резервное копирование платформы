Вы можете создать резервную копию DCImanager 6, содержащую все настройки платформы. Резервная копия сохраняется в формате архива tar и содержит файлы:

config.json — конфигурационный файл платформы;
docker-compose.yaml — конфигурационный файл Docker;
dci_dump.sql — дамп базы данных платформы.
Имена копий имеют вид YYYY_MM_DD__HH_MM.tar.gz.

 Пояснения
YYYY_MM_DD — дата создания;
HH_MM — время создания.

Обратите внимание!

Резервная копия не содержит данные статистики.

Резервное копирование и восстановление из резервной копии выполняет сервис установки платформы dci. Если на восстанавливаемом сервере DCImanager 6 не установлен или повреждён, сервис проведёт установку платформы, а затем восстановит данные из резервной копии.

Создание резервных копийLink to Создание резервных копий
Командная строка
Подключитесь к серверу DCImanager 6 по SSH и введите команду:

dci backup
Введите пароль для архива резервной копии или нажмите Enter, чтобы создать архив без пароля.
Копия будет сохранена в директории /opt/ispsystem/dci/backup/.

Интерфейс платформы
Вы можете настроить автосохранение резервных копий на внешнем хранилище или сервере с платформой. При выборе локального хранилища платформа будет сохранять копии в директории opt/ispsystem/dci/backup/. Рекомендуем сохранять резервные копии на внешнее хранилище, так как файлы копий могут быть повреждены при возникновении проблем с сервером платформы.

Если вы используете хранилище с подключением по FTP, проверьте валидность SSL-сертификата у доменного имени FTP-сервера. Если сертификат недействительный, платформа не сможет сохранить резервную копию.

 Если вы используете хранилище с подключением по NFS
Чтобы включить поддержку NFS-хранилищ:

Подключитесь к серверу с платформой по SSH.
Создайте файл patch_backup_nfs.yaml со следующим содержанием: 

Если на сервере установлена ОС Ubuntu 20.04

version: "3.7"
services:
  dci_backup:
    environment:
      BACKUP_NFS: "on"
    cap_add:
      - CAP_SYS_ADMIN
    security_opt:
      - apparmor=nfs-server
Если на сервере установлена другая ОС

version: "3.7"
services:
  dci_backup:
    environment:
      BACKUP_NFS: "on"
    cap_add:
      - CAP_SYS_ADMIN
Выполните команду: 

dci add-patch -f patch_backup_nfs.yaml -p backup_nfs
Чтобы отключить поддержку NFS-хранилищ, выполните на сервере с платформой команду: 

dci remove-patch -p backup_nfs


Чтобы настроить расписание резервного копирования, перейдите в → Резервное копирование → Добавить расписание:

Выберите когда нужно Создавать копии:
Ежедневно;
Еженедельно → выберите день недели;
Ежемесячно → введите число месяца с 1 по 28 → Применить;
задайте время в формате планировщика cron. Например, 15 10 * * 0 — создавать копии по воскресеньям в 10:15 UTC или 00 12 1,16 * * — создавать копии по 1-м и 16-м числам месяца в 12:00 UTC.
Введите время создания копии в UTC.
Укажите Название расписания. По умолчанию платформа создаёт расписание с именем, соответствующим настройкам расписания. Например, "Ежедневно в 0:00 по SSH".
Укажите произвольное Примечание к расписанию.
Выберите Тип хранилища для резервных копий: внешнее хранилище с подключением по SSH, FTP, NFS, SMB или локальное хранилище.

Если вы используете внешнее хранилище, укажите его настройки:

FTP или SSH:
IP-адрес или доменное имя;
Порт;
Логин;
Пароль или нажмите Хочу использовать публичный ssh-ключ для настройки соединения по SSH-ключу;
Путь хранения — директория на сервере, в которую платформа будет сохранять резервные копии.
NFS:
Сетевой путь хранения в формате <IP-адрес NFS-сервера>:/<директория хранения>. Например, 192.168.0.1:/mnt.
SMB:
IP-адрес хранилища.
Путь хранения в формате \<имя сетевого ресурса>\<директория хранения>\. Например, \share\backup\.
Логин и Пароль. Если подключение не требует аутентификации, включите опцию Анонимный вход.
Нажмите Добавить.

Пример настроек расписания


Вы можете управлять созданными расписаниями через меню  в разделе Резервное копирование. Возможные действия с расписанием:

Запустить копирование — выполнить внеочередной запуск;
Редактировать;
Включить/Выключить;
Примечание — добавить примечание;
Удалить.
Также в этом разделе вы можете скачать пять последних резервных копий платформы.


Раздел "Резервное копирование платформы"

Восстановление из резервной копииLink to Восстановление из резервной копии
Если DCImanager 6 на сервере не установлен
Сгенерируйте новый лицензионный токен в личном кабинете my.ispsystem.com.
Подключитесь к серверу по SSH.
Обновите операционную систему до последней стабильной версии.
Если в системе не установлен архиватор tar, установите его.
Cкачайте установщик:

curl -O https://download.ispsystem.com/6/dci/dcibox/dci
Сделайте файл установщика исполняемым:

chmod +x dci
Запустите восстановление:

./dci restore -b=<backup_file> -l <token>
 Пояснения к команде
<backup_file> — полный путь к файлу с резервной копией. Например, /opt/ispsystem/dci/backup/2022_03_30__00_00.tar.gz

<token> — лицензионный токен DCImanager 6

Если требуется, введите пароль к архиву резервной копии.
Если DCImanager 6 на сервере установлен
Сгенерируйте новый лицензионный токен в личном кабинете my.ispsystem.com.
Подключитесь к серверу по SSH.
Обновите операционную систему до последней стабильной версии.
Если в системе не установлен архиватор tar, установите его.
Укажите новый лицензионный токен в параметре LicenseToken конфигурационного файла /opt/ispsystem/dci/config.json.
Запустите восстановление:

dci restore -b=<backup_file> -l <token>
 Пояснения к команде
<backup_file> — полный путь к файлу с резервной копией. Например, /opt/ispsystem/dci/backup/2022_03_30__00_00.tar.gz

<token> — лицензионный токен DCImanager 6

Если требуется, введите пароль к архиву резервной копии.
